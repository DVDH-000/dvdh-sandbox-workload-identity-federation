

# **Resolving the Incorrect token audience Error: A Deep Dive into GCP-to-AWS Web Identity Federation in Apache Airflow**

## **Executive Summary**

The error message An error occurred (InvalidIdentityToken) when calling the AssumeRoleWithWebIdentity operation: Incorrect token audience represents a critical failure in the authentication handshake between a Google Cloud Platform (GCP) workload and Amazon Web Services (AWS). This issue, frequently encountered within data pipelines using Apache Airflow's GcsToS3Operator, is not an error in the data transfer logic itself, but a fundamental misconfiguration in the security and trust relationship established through OpenID Connect (OIDC) web identity federation. The root cause is a mismatch between the aud (Audience) claim embedded within the JSON Web Token (JWT) issued by Google and the audience value that the AWS Identity and Access Management (IAM) Role's trust policy expects and requires.

This report provides an exhaustive analysis and a prescriptive solution to this complex multi-cloud integration challenge. It begins by deconstructing the full Airflow and Boto3 exception traceback to precisely identify the point of failure: the AssumeRoleWithWebIdentity call to the AWS Security Token Service (STS). It then establishes the necessary theoretical foundation, offering a detailed examination of OIDC principles, the structure of JWTs, and the critical, often misunderstood, distinction between the aud and azp (Authorized Party) claims, particularly in the context of Google-issued tokens and their interpretation by AWS.

The core of this document is a step-by-step, architectural guide to correctly configuring the entire authentication chain. It provides detailed instructions for establishing the trust boundary on the AWS side by meticulously crafting the IAM OIDC Provider and the IAM Role's trust policy. Concurrently, it details the configuration of the identity on the GCP side, focusing on Workload Identity and the correct procedure for requesting an OIDC token with a specific audience. These two threads are then woven together within the Airflow orchestration layer, with explicit guidance on configuring the AWS and GCP connections, including a definitive configuration matrix that aligns Airflow parameters with the resulting token claims and the required IAM policy conditions.

Finally, this report equips engineers with a systematic troubleshooting playbook for diagnosing this class of error and concludes with a robust framework for security hardening. This includes applying the principle of least privilege by validating token subjects, implementing advanced audience strategies to prevent token replay attacks, and establishing detective controls through CloudTrail monitoring. By following this guide, organizations can build a secure, resilient, and correctly configured data pipeline that seamlessly federates identity across GCP and AWS.

## **Section 1: Anatomy of the Failure: Deconstructing the Airflow and Boto3 Traceback**

Understanding the precise origin of an error is the foundational step in its resolution. The traceback provided by the user, while lengthy, is a detailed map that leads directly to the root cause. It reveals a chain of exceptions where a high-level, user-facing error conceals a more fundamental, underlying security failure.

### **1.1. The Initial Symptom: S3UploadFailedError**

The error log culminates in a boto3.exceptions.S3UploadFailedError.1 This exception is raised by the Boto3 library's high-level S3 transfer manager when it fails to upload a file to an S3 bucket. At first glance, this might suggest a problem directly related to Amazon S3, such as incorrect bucket permissions, an invalid S3 key path, or network connectivity issues to the S3 endpoint.

However, this initial symptom is a wrapper exception. It signifies that the overall upload\_file process was aborted, but it does not describe the original cause of the failure.1 The Boto3 transfer manager is a sophisticated component that handles tasks like multi-part uploads, retries, and concurrency. A failure within any of its prerequisite steps, including the critical step of acquiring valid security credentials, will result in the entire operation failing and this high-level exception being thrown. Pursuing S3-specific debugging paths based on this symptom alone is inefficient and will likely lead to a dead end. The true cause lies deeper in the execution stack.

### **1.2. The Root Cause: InvalidIdentityTokenException**

A careful reading of the full traceback reveals that the S3UploadFailedError occurred *during the handling* of a previous, more fundamental exception: botocore.errorfactory.InvalidIdentityTokenException.1 This is the root cause of the pipeline failure. This exception is not related to the S3 service but to the AWS Security Token Service (STS).

The error is generated by the underlying botocore library, the low-level foundation upon which Boto3 is built. The traceback shows this exception is raised during a call to \_protected\_refresh within botocore/credentials.py.5 This function is part of Boto3's credential provider chain, which is responsible for automatically fetching or refreshing security credentials when they are needed.

The specific AWS API operation that fails is explicitly named in the traceback: client.assume\_role\_with\_web\_identity(...).6 This API call is the cornerstone of OIDC federation with AWS. It is designed to exchange a web identity token (from a provider like Google) for temporary AWS security credentials. The error message from the AWS STS endpoint is unequivocal and provides the critical diagnostic clue:

An error occurred (InvalidIdentityToken) when calling the AssumeRoleWithWebIdentity operation: Incorrect token audience.3 This message confirms that STS received the token but rejected it because the token was not intended for the recipient who presented it.

### **1.3. The Execution Flow: From Airflow Operator to AWS API**

To fully grasp the context, it is essential to trace the sequence of events from the Airflow DAG to the failed AWS API call.

1. **Airflow Operator Execution**: The process begins when the Airflow scheduler assigns a task instance of the GcsToS3Operator to a worker. The worker invokes the operator's execute method.8  
2. **Hook Instantiation**: The GcsToS3Operator internally uses hooks to interact with the respective cloud services. It uses a GCSHook to list and download objects from Google Cloud Storage and an S3Hook to upload objects to Amazon S3.11  
3. **Boto3 Client Interaction**: The S3Hook leverages the Boto3 library, the official AWS SDK for Python. It calls the high-level s3\_client.upload\_file(...) method to perform the transfer.1  
4. **Credential Acquisition**: The Boto3 client, having been configured for web identity federation, does not possess long-term static credentials (like an access key ID and secret key). Before it can sign the first API request to S3 (which would be CreateMultipartUpload for a sufficiently large file), it must obtain temporary credentials.  
5. **Just-in-Time Federation**: The Boto3 credential provider chain automatically triggers a call to the AWS STS. Specifically, it invokes the assume\_role\_with\_web\_identity operation, passing the OIDC token obtained from the GCP environment as the WebIdentityToken parameter.  
6. **Authentication Failure**: The AWS STS endpoint receives the request. It parses the JWT, validates its signature, and checks its claims. It is at this precise moment that STS examines the aud (or related) claim, finds that its value does not match the configured expectation for the IAM role being assumed, and rejects the request. It returns the InvalidIdentityTokenException with the Incorrect token audience message.  
7. **Exception Propagation**: This low-level exception propagates up the call stack. The Boto3 upload\_file method catches it and, unable to proceed without credentials, raises the S3UploadFailedError. This final error is what is logged by the Airflow worker, masking the original security failure.

This analysis reveals that the problem is not one of data access or transfer but of identity and authentication. The core of the issue lies in the content of the JWT and the trust policy of the IAM Role it is being presented to.

## **Section 2: The Foundational Mechanism: OIDC, JWTs, and the "Audience" Claim**

To effectively resolve the Incorrect token audience error, a clear understanding of the underlying technologies—OpenID Connect (OIDC), JSON Web Tokens (JWTs), and the specific role of the "Audience" claim—is indispensable. These components form the basis of the secure, passwordless authentication flow between GCP and AWS.

### **2.1. Web Identity Federation: A Primer**

Web identity federation is a system of trust that allows a user or workload authenticated by one system (an Identity Provider, or IdP) to access resources in another system (a Service Provider, or SP) without needing a separate set of credentials for the SP. In this scenario, GCP acts as the IdP, and AWS is the SP.

The OIDC protocol, which is built on top of OAuth 2.0, standardizes this process.6 The flow for the

GcsToS3Operator is as follows:

1. **Token Request**: The Airflow worker, running as a workload on GCP (e.g., on a GKE pod or GCE VM), requests a special credential called an OIDC ID Token from its local GCP metadata server. This token cryptographically proves the workload's identity.  
2. **Token Presentation**: The worker, via the Boto3 library, presents this GCP-issued ID Token to the AWS Security Token Service (STS) endpoint. This is done through the AssumeRoleWithWebIdentity API call.13  
3. **Token Validation**: AWS STS acts as the relying party. It validates the token by:  
   * Verifying its cryptographic signature against the public keys of the issuer (Google).  
   * Checking the claims inside the token (such as the issuer and expiration time).  
   * Crucially, verifying that the token was intended for it by checking the audience claim against a pre-configured list of allowed audiences in the corresponding IAM OIDC Provider configuration.  
4. **Credential Issuance**: If the token is valid and satisfies all conditions defined in the IAM Role's trust policy, STS generates a set of temporary, short-lived AWS security credentials (an access key ID, a secret access key, and a session token).  
5. **Resource Access**: The Airflow worker uses these temporary credentials to sign subsequent API requests to AWS services, such as the CreateMultipartUpload and PutObject calls to Amazon S3.

This mechanism is highly secure because it eliminates the need to store long-term AWS access keys on the GCP side. The credentials are temporary and scoped to the permissions of the assumed IAM Role.14

### **2.2. Anatomy of a JSON Web Token (JWT)**

A JWT is the vehicle for carrying identity information in this federated flow. It is a compact, URL-safe string that consists of three parts separated by dots (.): a Header, a Payload, and a Signature.15

* **Header**: Contains metadata about the token, such as the signing algorithm used (e.g., RS256).  
* **Signature**: A cryptographic signature that proves the token was issued by the claimed issuer and that its contents have not been tampered with.  
* **Payload (Claims)**: This is a JSON object containing statements, or "claims," about the entity (the subject) and the token itself. For the AssumeRoleWithWebIdentity flow, several claims are critical 16:  
  * iss (Issuer): A case-sensitive string identifying the principal that issued the JWT. For Google, this value is consistently https://accounts.google.com.17 AWS STS will verify that this matches the URL of the configured IAM OIDC Provider.  
  * sub (Subject): A case-sensitive string that identifies the principal that is the subject of the JWT. In the context of a GCP service account, this is the unique, immutable numeric ID of that service account.18  
  * exp (Expiration Time): A numeric timestamp identifying the expiration time on or after which the JWT MUST NOT be accepted for processing.1 STS will reject expired tokens.  
  * aud (Audience): This claim identifies the recipients that the JWT is intended for. According to the RFC 7519 standard, a principal processing the token MUST identify itself with a value in the audience claim. If it does not, the token MUST be rejected.15 This is the direct source of the user's error. The  
    aud value can be a single string or an array of strings.20

### **2.3. The aud vs. azp Dilemma: A Critical Nuance**

While the aud claim seems straightforward, its interaction with another optional claim, azp (Authorized Party), is a source of significant confusion and the key to resolving this specific error.

According to the OIDC specification, azp identifies the party to which the ID Token was issued—typically the OAuth 2.0 client that initiated the authentication request.22 The

aud claim identifies the party (or parties) that are intended to consume the token (the Relying Parties). In many simple flows, the client requesting the token is also the one consuming it, so aud and azp would be the same.

However, in more complex scenarios, they can differ. For example, a frontend single-page application (azp) might request a token that is intended to be consumed by a backend API (aud). This is where the distinction becomes vital.

The critical insight for this problem comes from how AWS STS specifically interprets tokens issued by Google for its workloads 18:

* When a GCP workload requests an OIDC token, the token Google issues contains both an aud and an azp claim.  
* The **azp (Authorized Party) claim** is set to the unique, numeric ID of the GCP service account that is requesting the token. This value is fixed for the service account.  
* The **aud (Audience) claim** is set to the value that the workload specified in the target\_audience parameter of its token request. This value is controlled by the client application (in this case, the Airflow AWS provider).

AWS STS is aware of this Google-specific behavior. When it validates the token, it maps its internal condition keys to these specific JWT claims 18:

* The AWS IAM condition key accounts.google.com:aud is validated against the **azp claim** in the JWT.  
* The AWS IAM condition key accounts.google.com:oaud (for "original audience") is validated against the **aud claim** in the JWT.

This non-obvious mapping is the central point of failure. An engineer, following the standard JWT specification, would naturally assume that configuring the "Audience" in the AWS IAM OIDC Provider and checking it in the trust policy would correspond to the aud claim in the token. For Google federation, this is incorrect. The primary audience check in AWS must be configured to match the value of the token's azp claim—the unique ID of the GCP service account. The Incorrect token audience error is the direct result of this mismatch.

## **Section 3: Configuring the AWS Trust Boundary: The IAM Role and OIDC Provider**

The AWS side of the federation is the "trusting party." Its configuration defines the security boundary, specifying which external identities are trusted and under what precise conditions they are allowed to assume a role. A misconfiguration here is the most common cause of the Incorrect token audience error.

### **3.1. Creating the IAM OIDC Identity Provider**

Before an IAM Role can trust tokens from Google, the AWS account must first be configured to recognize Google as a valid OpenID Connect (OIDC) identity provider. This is a one-time setup per account for each external IdP.

* **Provider URL**: This field must be set to the issuer URL of the IdP. For Google, this is always https://accounts.google.com.11 AWS uses this URL to fetch the OIDC discovery document (  
  .well-known/openid-configuration) and the JSON Web Key Set (JWKS), which contains the public keys needed to verify the signature of the JWTs.  
* **Audience**: This field is labeled "Audience" in the AWS console, but its function is to specify a client ID that is allowed to use this provider. Based on the analysis in the previous section, this field must be populated with the value that will appear in the azp claim of the Google-issued JWT. For a GCP service account, this is its unique, 21-digit numeric ID.11 It is critical to understand that this is  
  **not** a URL or a descriptive string, but the specific ID of the service account principal. You can add multiple audiences if multiple service accounts need to use this provider.

Failure to set the Audience field to the correct GCP service account ID is a direct cause of the InvalidIdentityToken error, as STS will not find a matching client ID for the token presented.

### **3.2. Crafting the IAM Role and its Trust Policy**

An IAM Role is an identity that does not have its own long-term credentials. Instead, it is designed to be "assumed" by other trusted principals, who then inherit the permissions assigned to the role for a temporary period.14 The core of an IAM Role is its

**Trust Policy**. This is a resource-based JSON policy document that explicitly defines *who* can assume the role and under *what conditions*.

The trust policy for web identity federation must contain the following elements:

* **Effect**: Must be "Allow".  
* **Principal**: This element specifies the trusted entity. For OIDC federation, the principal is not a user or another role, but the OIDC provider itself. The value must be the Amazon Resource Name (ARN) of the IAM OIDC Provider created in the previous step. For example:  
  JSON  
  "Principal": {  
    "Federated": "arn:aws:iam::123456789012:oidc-provider/accounts.google.com"  
  }

  This statement declares that the role can be assumed by principals who authenticate through the specified OIDC provider.14  
* **Action**: The only permissible action for this type of trust policy is sts:AssumeRoleWithWebIdentity.17 This grants the principal permission to call this specific STS API operation to trade their OIDC token for temporary AWS credentials.

### **3.3. The Critical Condition Clause: Enforcing the Audience**

The Principal and Action elements are necessary but not sufficient for a secure configuration. Without a Condition element, any identity that can get a token from the trusted IdP (Google) and knows the role ARN could assume the role. The Condition block is where the claims within the JWT are inspected to enforce fine-grained access control. This is where the Incorrect token audience error is resolved.

Based on the established understanding of how AWS interprets Google's OIDC tokens, the trust policy's Condition clause must perform a StringEquals check on the accounts.google.com:aud key. This key corresponds to the azp claim in the token, which contains the unique ID of the GCP service account.

A correctly configured, minimal trust policy would look like this:

JSON

{  
  "Version": "2012-10-17",  
  "Statement":  
}

In this policy:

* "Federated": "arn:aws:iam::123456789012:oidc-provider/accounts.google.com" identifies the trusted issuer.  
* "Action": "sts:AssumeRoleWithWebIdentity" specifies the allowed operation.  
* "Condition": { "StringEquals": { "accounts.google.com:aud": "..." } } is the crucial validation step. It instructs AWS STS to look at the azp claim of the incoming JWT and only allow the assumption if its value exactly matches the specified GCP service account's unique ID.

If this condition is missing, or if it checks for the wrong value (e.g., a URL or a different string), AWS STS will reject the token with the Incorrect token audience error because the primary audience validation check has failed. This is the most likely source of the user's issue.

## **Section 4: Configuring the GCP Identity: Workload Identity and Token Generation**

The "issuing party" in this federation is GCP. The configuration on this side involves defining the workload's identity via a service account and ensuring it requests an OIDC token with the correct parameters to satisfy the AWS trust boundary.

### **4.1. GCP Workload Identity and Service Accounts**

In Google Cloud, a Service Account is a special type of non-human identity that can be used by applications, virtual machines, or other services to authenticate to Google Cloud APIs.27 For workloads running on services like Google Kubernetes Engine (GKE) or Compute Engine (GCE), GCP provides a mechanism called

**Workload Identity**.25

Workload Identity is the recommended way to allow applications within GKE to access Google Cloud services. It works by linking a Kubernetes service account (KSA) to a GCP IAM service account (SA). When a pod uses the KSA, it can automatically authenticate as the linked GCP SA without needing to mount service account key files, which is a significant security improvement. Similarly, a GCE VM is assigned a service account upon creation, and code running on that VM can seamlessly use its identity.

For the GcsToS3Operator use case, it is a security best practice to create a dedicated, least-privilege GCP service account for the Airflow workers. This service account should only have the permissions necessary to read from the source GCS bucket (roles/storage.objectViewer).

### **4.2. Requesting the OIDC Token from the Metadata Server**

A key feature of running workloads on GCP is the metadata server. This is a special endpoint accessible from within a VM or pod at a well-known IP address (169.254.169.254) that provides metadata about the running instance, including its identity credentials.30 Instead of handling private keys, an application can simply make an HTTP request to the metadata server to obtain a short-lived OIDC ID token.33

The request to the metadata server's identity endpoint must include a crucial parameter: audience. The value provided for this parameter is what Google will place into the aud claim of the resulting JWT. This is the client's opportunity to specify the intended recipient of the token.

The following Python code, which uses the google-auth library, demonstrates how an application (like the Airflow AWS provider) fetches this token. This is what happens under the hood when the provider is configured for Google web identity federation.

Python

import google.auth.transport.requests  
import google.oauth2.id\_token  
from google.auth.exceptions import DefaultCredentialsError

def get\_gcp\_oidc\_token(target\_audience: str) \-\> str:  
    """  
    Fetches an OIDC ID token from the GCP metadata server for a specific audience.

    Args:  
        target\_audience: The intended audience for the ID token. This value will be  
                         placed in the 'aud' claim of the JWT.

    Returns:  
        The OIDC ID token as a string.  
    """  
    try:  
        \# The google-auth library handles the interaction with the metadata server.  
        \# It automatically finds the attached service account credentials.  
        request \= google.auth.transport.requests.Request()  
          
        \# This is the critical call that requests the token.  
        \# The 'audience' parameter directly controls the 'aud' claim in the token.  
        id\_token \= google.oauth2.id\_token.fetch\_id\_token(  
            request, audience=target\_audience  
        )  
          
        print(f"Successfully fetched OIDC token for audience: {target\_audience}")  
        return id\_token

    except DefaultCredentialsError:  
        print("Error: Could not find default credentials.")  
        print("Ensure this code is running on a GCP workload (GCE, GKE, etc.)")  
        print("with a service account attached.")  
        raise  
    except Exception as e:  
        print(f"An unexpected error occurred: {e}")  
        raise

\# Example usage:  
\# This value must align with the AWS IAM Role's trust policy condition.  
\# For example, 'sts.amazonaws.com' or a more specific unique identifier.  
aws\_audience \= 'sts.amazonaws.com'   
\# In a real scenario, this token would be passed as the WebIdentityToken  
\# parameter to the AWS STS AssumeRoleWithWebIdentity call.  
\# oidc\_token \= get\_gcp\_oidc\_token(aws\_audience)

This code explicitly shows that the value of the aud claim in the JWT is directly controlled by the client application at the time of the token request. This establishes the final link in the configuration chain: the value configured in the Airflow AWS connection will be passed as this target\_audience, which in turn must match the condition configured in the AWS IAM trust policy.

## **Section 5: The Orchestration Layer: Integrating Airflow's AWS and GCP Connections**

With the AWS trust boundary and the GCP identity configured, the final step is to correctly configure Apache Airflow to bridge the two. This is accomplished through the gcp\_conn\_id and dest\_aws\_conn\_id parameters of the GcsToS3Operator, which point to connections defined in Airflow's metadata database.

### **5.1. The GCP Connection (gcp\_conn\_id)**

The GcsToS3Operator uses the connection specified by gcp\_conn\_id (which defaults to google\_cloud\_default) to authenticate with Google Cloud Storage.8 When Airflow is running on a GCP environment like GKE or GCE, the best practice is to leverage Application Default Credentials (ADC).28

To use ADC, the Airflow connection should be configured with the "Google Cloud" connection type, but the key authentication fields (like "Keyfile Path" or "Keyfile JSON") should be left blank. The google-auth library, used by the Airflow Google provider, will automatically detect that it is running on GCP and will use the metadata server to obtain credentials from the service account attached to the worker instance.28 This avoids the need to manage and rotate JSON key files.

### **5.2. The AWS Connection (dest\_aws\_conn\_id)**

This is the most critical part of the Airflow configuration and where the web identity federation is explicitly enabled. The connection specified by dest\_aws\_conn\_id (defaulting to aws\_default) must be configured to instruct Boto3 to perform the AssumeRoleWithWebIdentity flow instead of looking for static keys.

This configuration is done within the Extra field of the AWS connection, which accepts a JSON object. The following keys are required for Google-to-AWS federation 11:

* "role\_arn": The full ARN of the AWS IAM Role that was created in Section 3\. This tells STS which role to assume.  
* "assume\_role\_method": This must be set to the exact string "assume\_role\_with\_web\_identity". This switches the Boto3 credential provider from the default behavior to the web identity federation flow.  
* "assume\_role\_with\_web\_identity\_federation": This must be set to "google". This is a special flag for the Airflow AWS provider that tells it to use the Google-specific logic for obtaining an OIDC token from the metadata server.  
* "assume\_role\_with\_web\_identity\_federation\_audience": This optional but highly recommended parameter specifies the value to be used as the target\_audience when requesting the OIDC token from Google. The value provided here will populate the aud claim in the JWT.

An example of a complete Extra JSON configuration for the Airflow AWS connection would be:

JSON

{  
    "role\_arn": "arn:aws:iam::123456789012:role/GcpAirflowS3AccessRole",  
    "assume\_role\_method": "assume\_role\_with\_web\_identity",  
    "assume\_role\_with\_web\_identity\_federation": "google",  
    "assume\_role\_with\_web\_identity\_federation\_audience": "sts.amazonaws.com"  
}

### **5.3. Configuration Matrix for Success**

The relationship between the Airflow connection, the generated JWT, and the AWS IAM policy is precise and unforgiving. A mismatch in any part of the chain will result in the Incorrect token audience error. The following matrix provides a clear, prescriptive guide to ensure these components are perfectly aligned.

The primary condition in the AWS IAM trust policy must always validate the GCP service account's unique ID against the azp claim:  
"Condition": { "StringEquals": { "accounts.google.com:aud": "YOUR\_GCP\_SERVICE\_ACCOUNT\_UNIQUE\_ID" } }  
The table below details how to configure the secondary, recommended audience check based on the assume\_role\_with\_web\_identity\_federation\_audience parameter in the Airflow connection. This secondary check validates the aud claim in the token via the accounts.google.com:oaud condition key.

| Airflow AWS Conn Extra (assume\_role\_with\_web\_identity\_federation\_audience) | Resulting aud Claim in JWT | Recommended Secondary Condition in AWS IAM Trust Policy | Security Level |
| :---- | :---- | :---- | :---- |
| (Not set) | A default GCP-generated URL | "StringEquals": {"accounts.google.com:oaud": "DEFAULT\_GCP\_URL"} | **Low**: Relies on a default, less specific audience. Not recommended for production. |
| "sts.amazonaws.com" | "sts.amazonaws.com" | "StringEquals": {"accounts.google.com:oaud": "sts.amazonaws.com"} | **Medium**: Standard practice, indicates the token is for AWS STS. Good for general use. |
| "my-unique-app-identifier" | "my-unique-app-identifier" | "StringEquals": {"accounts.google.com:oaud": "my-unique-app-identifier"} | **High**: Best practice. Uses a specific, non-guessable identifier for the application, preventing the token from being replayed for other purposes. |

Putting it all together, a fully hardened IAM trust policy that incorporates both the primary (azp) and secondary (aud) checks would be:

JSON

{  
  "Version": "2012-10-17",  
  "Statement":  
}

This policy requires that the token be from the service account with the unique ID 112233445566778899000 **AND** that it was requested with the specific audience my-airflow-gcs-to-s3-prod-pipeline. This provides a robust, layered defense against misuse.

## **Section 6: A Systematic Troubleshooting Playbook**

When faced with an Incorrect token audience error, a systematic approach is required to quickly pinpoint the misconfiguration. This playbook provides a concrete set of diagnostic steps.

### **Step 1: Isolate and Decode the JWT**

The most effective troubleshooting step is to make the abstract problem concrete by examining the actual JWT being generated.

1. **Isolate Token Generation**: In your Airflow DAG, temporarily disable or comment out the GcsToS3Operator. Replace it with a PythonOperator.  
2. **Fetch and Log the Token**: Inside the PythonOperator's callable function, use the Python code from Section 4.2 to fetch the OIDC token. Crucially, use the *exact same audience string* that is configured in your AWS connection's Extra JSON. Print the fetched token to the Airflow logs.  
   Python  
   from airflow.operators.python import PythonOperator

   def log\_gcp\_oidc\_token():  
       import google.auth.transport.requests  
       import google.oauth2.id\_token

       \# Use the SAME audience as your Airflow AWS connection  
       audience \= "sts.amazonaws.com" 

       print("Attempting to fetch OIDC token...")  
       token \= google.oauth2.id\_token.fetch\_id\_token(  
           google.auth.transport.requests.Request(), audience=audience  
       )  
       print("--- BEGIN OIDC TOKEN \---")  
       print(token)  
       print("--- END OIDC TOKEN \---")

   log\_token\_task \= PythonOperator(  
       task\_id='log\_gcp\_oidc\_token',  
       python\_callable=log\_gcp\_oidc\_token,  
   )

3. **Decode the Token**: Trigger the DAG and view the task logs. Copy the entire token string (it will be very long). Paste this token into a JWT debugger tool like jwt.io. This tool will decode the header and payload, allowing you to inspect the claims directly.

### **Step 2: Audit the Token Claims vs. the Trust Policy**

With the decoded token claims visible, perform a meticulous audit against your IAM Role's trust policy. Create a checklist:

* **\[ \] Issuer (iss)**: Does the iss claim in the token payload exactly match https://accounts.google.com?  
* **\[ \] Primary Audience (azp)**: Does the azp (Authorized Party) claim in the token payload exactly match the value specified for the accounts.google.com:aud condition in your trust policy? This should be the unique numeric ID of your GCP service account.  
* **\[ \] Secondary Audience (aud)**: If you are using a secondary audience check, does the aud claim in the token payload exactly match the value specified for the accounts.google.com:oaud condition in your trust policy? This should match the assume\_role\_with\_web\_identity\_federation\_audience value from your Airflow connection.  
* **\[ \] Subject (sub)**: If you are restricting by subject, does the sub claim in the token payload match the value specified for the accounts.google.com:sub condition in your trust policy?

Any "no" answer on this checklist points directly to the misconfiguration that needs to be corrected.

### **Step 3: Verify Airflow Configurations**

If the token claims appear correct, double-check the Airflow connection itself for simple errors:

* **Check the AWS Connection (dest\_aws\_conn\_id)**:  
  * Is the role\_arn in the Extra field correct, with no typos?  
  * Is the Extra field valid JSON? A missing comma or quote can invalidate the entire configuration.  
  * Confirm the keys (assume\_role\_method, etc.) are spelled correctly.11  
* **Check the GCP Connection (gcp\_conn\_id)**:  
  * If using ADC, ensure the keyfile fields are empty.  
  * If using a keyfile, ensure the path is correct and the Airflow worker has read access to it.

### **Step 4: Investigate Environmental Factors (The Red Herrings)**

While Incorrect token audience strongly implies a configuration error, other InvalidIdentityToken messages can stem from environmental issues. If the above steps do not resolve the problem, consider these less likely possibilities:

* **Network and Firewall Connectivity**: The AWS STS service needs to be able to communicate with the IdP's (Google's) public OIDC discovery endpoints to retrieve public keys for token validation. If the Airflow worker is in a restricted network environment, ensure that egress traffic to accounts.google.com and its associated domains on port 443 is allowed.34  
* **Latency**: The entire AssumeRoleWithWebIdentity operation, including the callback from STS to the IdP, has a timeout. Extremely high network latency between AWS and Google's infrastructure could theoretically cause a timeout that manifests as a token validation failure.34 Using regional STS endpoints (  
  sts.\<region\>.amazonaws.com) instead of the global one can sometimes mitigate latency issues.  
* **Throttling**: If an application makes an excessive number of role assumption requests, it could be throttled by either the IdP or by AWS STS. This is unlikely in a typical Airflow DAG run but could occur in highly concurrent or misconfigured systems. Implementing retry logic with exponential backoff in custom operators can help, though the standard Boto3 client used by the provider has some built-in retry behavior.5

## **Section 7: Security Hardening and Architectural Recommendations**

Achieving a functional connection is only the first step. A production-grade system requires a security-first approach. The following recommendations will harden the federated identity configuration against potential threats.

### **7.1. Applying the Principle of Least Privilege**

The principle of least privilege dictates that an identity should only have the exact permissions required to perform its intended function. This applies to both the permissions granted by the IAM role and, just as importantly, the conditions under which the role can be assumed.

The audience checks (azp and aud) confirm that the token was intended for this purpose. However, they do not restrict *which* GCP service account can present such a token. Any service account within the GCP project that is listed as an audience on the IAM OIDC Provider could potentially generate a token and assume the role.

To tighten this, the trust policy should be enhanced to validate the **sub (Subject)** claim of the JWT. The sub claim contains the unique identifier of the principal (the service account) to whom the token was issued. By adding a condition to check the sub claim, you ensure that only one specific GCP service account can assume the role.

For Google service accounts, the unique numeric ID is used for both the sub claim and the azp claim. Therefore, a hardened trust policy validates that these are identical and match the specific service account you intend to grant access.

**Hardened Trust Policy Example:**

JSON

{  
  "Version": "2012-10-17",  
  "Statement":  
}

This policy now enforces that the token must have been issued *to* a specific service account (sub check) and that it was requested *by* that same service account (aud \-\> azp check), effectively locking down role assumption to a single, known identity.

### **7.2. Audience Strategy and Token Replay Prevention**

The aud claim is a powerful tool for preventing token replay attacks. A token replay attack occurs when a valid token intended for one purpose is intercepted and "replayed" to a different service to gain unauthorized access.

Using a generic audience like "sts.amazonaws.com" is acceptable, but a stronger security posture uses unique, non-guessable audience strings for different applications or environments.19

Consider a scenario with dev and prod environments. You can define two distinct audiences:

* airflow-gcs-s3-sync-dev  
* airflow-gcs-s3-sync-prod

You would then configure the dev Airflow connection to request the dev audience and the prod connection to request the prod audience. The respective dev and prod IAM roles would have trust policies that only accept their corresponding audience. This ensures that a token captured from the dev environment, even if it's from the correct service account, cannot be used to assume the highly privileged prod role because its aud claim will not match.

### **7.3. Monitoring and Alerting with CloudTrail**

While the InvalidIdentityToken failure occurs on the client side and is not logged in AWS CloudTrail, successful AssumeRoleWithWebIdentity events *are* logged.7 This provides a valuable audit trail and an opportunity for detective controls.

It is highly recommended to configure CloudTrail to monitor these events and create Amazon CloudWatch Alarms or EventBridge rules based on them. This allows you to:

* **Monitor for Success**: Keep a log of every time the cross-cloud role is successfully assumed.  
* **Alert on Anomalies**: Create alerts for role assumptions that occur outside of expected business hours or from unexpected source IP ranges (if applicable).  
* **Investigate Activity**: The CloudTrail log entry for AssumeRoleWithWebIdentity includes the roleSessionName provided by the client, the source identity from the token, and the ARN of the assumed role. This information is invaluable during a security investigation to attribute actions taken with the temporary credentials back to the originating workload.

By implementing these security measures, the web identity federation architecture moves from being merely functional to being robust, resilient, and aligned with enterprise security best practices.

#### **Works cited**

1. boto3 aws sdk InvalidIdentityToken error encountered when using AWS SDK for Python (Boto3). \- Doctor Droid, accessed on August 7, 2025, [https://drdroid.io/stack-diagnosis/boto3-aws-sdk-invalididentitytoken-error-encountered-when-using-aws-sdk-for-python--boto3](https://drdroid.io/stack-diagnosis/boto3-aws-sdk-invalididentitytoken-error-encountered-when-using-aws-sdk-for-python--boto3)  
2. InvalidToken when uploading files to S3 in new region(s) with assumed role · Issue \#4580 · boto/boto3 \- GitHub, accessed on August 7, 2025, [https://github.com/boto/boto3/issues/4580](https://github.com/boto/boto3/issues/4580)  
3. Troubleshooting pipeline build failing with "An error occurred (InvalidIdentityToken) when calling the AssumeRoleWithWebIdentity operation: Incorrect token audience" | Bitbucket Cloud | Atlassian Support, accessed on August 7, 2025, [https://support.atlassian.com/bitbucket-cloud/kb/troubleshooting-pipeline-build-failing-with-an-error-occurred-invalididentitytoken-when-calling-the-assumerolewithwebidentity-operation-incorrect-token-audience/](https://support.atlassian.com/bitbucket-cloud/kb/troubleshooting-pipeline-build-failing-with-an-error-occurred-invalididentitytoken-when-calling-the-assumerolewithwebidentity-operation-incorrect-token-audience/)  
4. OIDC and boto3: InvalidIdentityToken \- Atlassian Community, accessed on August 7, 2025, [https://community.atlassian.com/forums/Bitbucket-questions/OIDC-and-boto3-InvalidIdentityToken/qaq-p/2311310](https://community.atlassian.com/forums/Bitbucket-questions/OIDC-and-boto3-InvalidIdentityToken/qaq-p/2311310)  
5. Error handling \- Boto3 1.40.2 documentation, accessed on August 7, 2025, [https://boto3.amazonaws.com/v1/documentation/api/latest/guide/error-handling.html](https://boto3.amazonaws.com/v1/documentation/api/latest/guide/error-handling.html)  
6. AssumeRoleWithWebIdentity \- AWS Security Token Service, accessed on August 7, 2025, [https://docs.aws.amazon.com/STS/latest/APIReference/API\_AssumeRoleWithWebIdentity.html](https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRoleWithWebIdentity.html)  
7. assume\_role\_with\_web\_identity \- Boto3 1.40.1 documentation \- AWS, accessed on August 7, 2025, [https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sts/client/assume\_role\_with\_web\_identity.html](https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sts/client/assume_role_with_web_identity.html)  
8. airflow.providers.amazon.aws.transfers.gcs\_to\_s3, accessed on August 7, 2025, [https://airflow.apache.org/docs/apache-airflow-providers-amazon/stable/\_api/airflow/providers/amazon/aws/transfers/gcs\_to\_s3/index.html](https://airflow.apache.org/docs/apache-airflow-providers-amazon/stable/_api/airflow/providers/amazon/aws/transfers/gcs_to_s3/index.html)  
9. Google Cloud Storage to Amazon S3 transfer operator \- Apache Airflow, accessed on August 7, 2025, [https://airflow.apache.org/docs/apache-airflow-providers-amazon/stable/transfer/gcs\_to\_s3.html](https://airflow.apache.org/docs/apache-airflow-providers-amazon/stable/transfer/gcs_to_s3.html)  
10. airflow.providers.amazon.aws.transfers.gcs\_to\_s3, accessed on August 7, 2025, [https://airflow.apache.org/docs/apache-airflow-providers-amazon/4.1.0/\_api/airflow/providers/amazon/aws/transfers/gcs\_to\_s3/index.html](https://airflow.apache.org/docs/apache-airflow-providers-amazon/4.1.0/_api/airflow/providers/amazon/aws/transfers/gcs_to_s3/index.html)  
11. Amazon Web Services Connection — apache-airflow-providers ..., accessed on August 7, 2025, [https://airflow.apache.org/docs/apache-airflow-providers-amazon/stable/connections/aws.html](https://airflow.apache.org/docs/apache-airflow-providers-amazon/stable/connections/aws.html)  
12. Configuring OpenID Connect in Amazon Web Services \- GitHub Docs, accessed on August 7, 2025, [https://docs.github.com/actions/security-for-github-actions/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services](https://docs.github.com/actions/security-for-github-actions/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services)  
13. STS — Boto3 Docs 1.20.0 documentation \- AWS, accessed on August 7, 2025, [https://boto3.amazonaws.com/v1/documentation/api/1.20.0/reference/services/sts.html](https://boto3.amazonaws.com/v1/documentation/api/1.20.0/reference/services/sts.html)  
14. How to use trust policies with IAM roles | AWS Security Blog \- Amazon.com, accessed on August 7, 2025, [https://aws.amazon.com/blogs/security/how-to-use-trust-policies-with-iam-roles/](https://aws.amazon.com/blogs/security/how-to-use-trust-policies-with-iam-roles/)  
15. RFC 7519 \- JSON Web Token (JWT) \- IETF Datatracker, accessed on August 7, 2025, [https://datatracker.ietf.org/doc/html/rfc7519](https://datatracker.ietf.org/doc/html/rfc7519)  
16. Using JWT to authenticate users | API Gateway Documentation \- Google Cloud, accessed on August 7, 2025, [https://cloud.google.com/api-gateway/docs/authenticating-users-jwt](https://cloud.google.com/api-gateway/docs/authenticating-users-jwt)  
17. Error InvalidIdentityToken in command aws sts assume-role-with-web-identity, accessed on August 7, 2025, [https://stackoverflow.com/questions/77371029/error-invalididentitytoken-in-command-aws-sts-assume-role-with-web-identity](https://stackoverflow.com/questions/77371029/error-invalididentitytoken-in-command-aws-sts-assume-role-with-web-identity)  
18. Access AWS using a Google Cloud Platform native workload identity | AWS Security Blog, accessed on August 7, 2025, [https://aws.amazon.com/blogs/security/access-aws-using-a-google-cloud-platform-native-workload-identity/](https://aws.amazon.com/blogs/security/access-aws-using-a-google-cloud-platform-native-workload-identity/)  
19. How to Use the JWT "aud" Claim Securely \- Descope, accessed on August 7, 2025, [https://www.descope.com/blog/post/jwt-aud-claim](https://www.descope.com/blog/post/jwt-aud-claim)  
20. JWT (Json Web Token) Audience "aud" versus Client\_Id \- What's the difference?, accessed on August 7, 2025, [https://stackoverflow.com/questions/28418360/jwt-json-web-token-audience-aud-versus-client-id-whats-the-difference](https://stackoverflow.com/questions/28418360/jwt-json-web-token-audience-aud-versus-client-id-whats-the-difference)  
21. JWT Audience (aud) \- MojoAuth, accessed on August 7, 2025, [https://mojoauth.com/glossary/jwt-audience/](https://mojoauth.com/glossary/jwt-audience/)  
22. Consider customizing 'azp' and 'aud' claims in ID Tokens · Issue ..., accessed on August 7, 2025, [https://github.com/ory/hydra/issues/2042](https://github.com/ory/hydra/issues/2042)  
23. OpenID Connect Standard: Authorized Party azp Contradiction \- Stack Overflow, accessed on August 7, 2025, [https://stackoverflow.com/questions/41231018/openid-connect-standard-authorized-party-azp-contradiction](https://stackoverflow.com/questions/41231018/openid-connect-standard-authorized-party-azp-contradiction)  
24. AssumeRoleWithWebIdentity uses azp instead of aud as audience \- AWS re:Post, accessed on August 7, 2025, [https://repost.aws/questions/QUxV1IO-p2R3ix-T8TUV853g/assumerolewithwebidentity-uses-azp-instead-of-aud-as-audience](https://repost.aws/questions/QUxV1IO-p2R3ix-T8TUV853g/assumerolewithwebidentity-uses-azp-instead-of-aud-as-audience)  
25. Cross-cloud identities between GCP and AWS from GKE and/or EKS | by Jason Umiker, accessed on August 7, 2025, [https://jason-umiker.medium.com/cross-cloud-identities-between-gcp-and-aws-from-gke-and-or-eks-182652bddadb](https://jason-umiker.medium.com/cross-cloud-identities-between-gcp-and-aws-from-gke-and-or-eks-182652bddadb)  
26. IAM roles \- AWS Identity and Access Management \- AWS Documentation, accessed on August 7, 2025, [https://docs.aws.amazon.com/IAM/latest/UserGuide/id\_roles.html](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html)  
27. Using OAuth 2.0 for Server to Server Applications | Google for Developers, accessed on August 7, 2025, [https://developers.google.com/identity/protocols/oauth2/service-account](https://developers.google.com/identity/protocols/oauth2/service-account)  
28. Google Cloud Connection \- Apache Airflow, accessed on August 7, 2025, [https://airflow.apache.org/docs/apache-airflow-providers-google/stable/connections/gcp.html](https://airflow.apache.org/docs/apache-airflow-providers-google/stable/connections/gcp.html)  
29. Configure Workload Identity Federation with AWS or Azure VMs | IAM Documentation, accessed on August 7, 2025, [https://cloud.google.com/iam/docs/workload-identity-federation-with-other-clouds](https://cloud.google.com/iam/docs/workload-identity-federation-with-other-clouds)  
30. Get an ID token | Authentication \- Google Cloud, accessed on August 7, 2025, [https://cloud.google.com/docs/authentication/get-id-token](https://cloud.google.com/docs/authentication/get-id-token)  
31. Verify VM identity | Compute Engine Documentation \- Google Cloud, accessed on August 7, 2025, [https://cloud.google.com/compute/docs/instances/verifying-instance-identity](https://cloud.google.com/compute/docs/instances/verifying-instance-identity)  
32. Three methods for obtaining GCP access tokens | Dataminded \- Medium, accessed on August 7, 2025, [https://medium.com/datamindedbe/three-methods-for-obtaining-gcp-access-tokens-7a516a79129a](https://medium.com/datamindedbe/three-methods-for-obtaining-gcp-access-tokens-7a516a79129a)  
33. GCP: How to get compute engine access token? \- Stack Overflow, accessed on August 7, 2025, [https://stackoverflow.com/questions/54927451/gcp-how-to-get-compute-engine-access-token](https://stackoverflow.com/questions/54927451/gcp-how-to-get-compute-engine-access-token)  
34. How do I resolve the AWS STS AssumeRoleWithWebIdentity API call error "InvalidIdentityToken"?, accessed on August 7, 2025, [https://repost.aws/knowledge-center/iam-sts-invalididentitytoken](https://repost.aws/knowledge-center/iam-sts-invalididentitytoken)  
35. Resolve errors related to OIDC IdP federation in IAM \- AWS re:Post, accessed on August 7, 2025, [https://repost.aws/knowledge-center/iam-oidc-idp-federation](https://repost.aws/knowledge-center/iam-oidc-idp-federation)